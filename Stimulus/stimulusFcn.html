
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>STIMULUSFCN</title><meta name="generator" content="MATLAB 8.0"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2014-11-07"><meta name="DC.source" content="stimulusFcn.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, tt, code { font-size:12px; }
pre { margin:0px 0px 20px; }
pre.error { color:red; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>STIMULUSFCN</h1><!--introduction--><pre>Generates time series for stimulus signal.
Called by stimulusMake; not a standalone function.</pre><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#3">Loop through number of components of signal</a></li><li><a href="#5">Create complete amplitude/frequency vectors if time-varying</a></li><li><a href="#6">Create frequency modulation</a></li><li><a href="#7">Create amplitude modulation</a></li><li><a href="#8">Create carrier and apply modulators</a></li><li><a href="#9">Apply delay-and-add circuit</a></li><li><a href="#10">Add component to signal</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> x = stimulusFcn(t, s, a)
</pre><pre class="codeinput">x = zeros(size(t));               <span class="comment">% Initialize signal vector</span>
fs = s.fs;
</pre><h2>Loop through number of components of signal<a name="3"></a></h2><pre class="codeinput"><span class="keyword">for</span> b = 1:length(s.fc(a,:))       <span class="comment">% For each component of the section</span>
</pre><pre class="codeinput">    fc = s.fc{a,b};ac = s.ac{a,b};

    <span class="keyword">if</span> isfield(s, <span class="string">'FM'</span>), fm = s.fFM{a,b};am = s.aFM{a,b};
    <span class="keyword">else</span>
        fm = 0;am = 0;
    <span class="keyword">end</span>

    <span class="keyword">if</span> isfield(s, <span class="string">'AM'</span>), fAM = s.fAM{a,b};aAM = s.aAM{a,b};
    <span class="keyword">else</span>
        fAM = 0;aAM = 0;
    <span class="keyword">end</span>
</pre><h2>Create complete amplitude/frequency vectors if time-varying<a name="5"></a></h2><pre class="codeinput">    temp = {fc fm fAM ac am aAM};

    <span class="keyword">for</span> i = 1:6
        linear = 0;
        <span class="keyword">if</span> length(temp{i}) &gt; 1
            <span class="keyword">if</span> length(temp{i}) == 2, linear = 1;<span class="keyword">end</span>
            temp{i} = interp1(linspace(0,t(end),length(temp{i})),temp{i},t);
            <span class="keyword">if</span> i &lt; 4
                deriv = diff(temp{i})*fs;
                <span class="keyword">if</span> linear
                    deriv = -[deriv deriv(end)];
                <span class="keyword">else</span>
                    deriv = -interp1(linspace(deriv(1),deriv(end),<span class="keyword">...</span>
                        length(deriv)),deriv,linspace(deriv(1),deriv(end),<span class="keyword">...</span>
                        length(deriv)+1));
                <span class="keyword">end</span>
                temp{i} = (temp{i} + t.*deriv/2);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    fc = temp{1};fm = temp{2};fAM = temp{3};
    ac = temp{4};am = temp{5};aAM = temp{6};
</pre><h2>Create frequency modulation<a name="6"></a></h2><pre class="codeinput">    <span class="keyword">if</span> isfield(s, <span class="string">'FM'</span>)

        <span class="keyword">if</span> fm ~= 0
            tflr = floor(t.*fm)./fm;
            trem = rem(t,1./fm);
            q = 2*pi*fm.*t;

            <span class="keyword">switch</span> lower(s.FM{a,b}(1:3))
                <span class="keyword">case</span> <span class="string">'cos'</span>
                    mi= ((q-sin(q))/2)/2/pi./fm; <span class="comment">% integral of -cos(q)</span>
                <span class="keyword">case</span> <span class="string">'saw'</span>
                    mi= tflr/2 + (fm.*trem.^2)/2; <span class="comment">% (fm*t.^2)/2 is integral of fm*t</span>
                <span class="keyword">case</span> <span class="string">'squ'</span>
                    hlin = zeros(size(trem)); ii = find(trem&gt;1./fm/2); <span class="comment">% yuk!!!</span>
                    hlin(ii) = trem(ii)-1./fm/2;
                    mi= (tflr + 2*hlin)/2; <span class="comment">% (2*t)/2 is integral of 1</span>
                <span class="keyword">otherwise</span>
                    am = 0;
                    mi = 0;
                    warning(<span class="string">'Unknown FM modulator type, not modulating'</span>);
            <span class="keyword">end</span>
        <span class="keyword">else</span>
            am = 0;
            mi = 0;
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        am = 0;
        mi = 0;
    <span class="keyword">end</span>
</pre><h2>Create amplitude modulation<a name="7"></a></h2><pre class="codeinput">    <span class="keyword">if</span> isfield(s, <span class="string">'AM'</span>);

        Cfreq = s.CfreqsAM(a,b);
        AM = zeros(size(t));

        <span class="keyword">switch</span> lower(s.AM{a,b})
            <span class="keyword">case</span> <span class="string">'cos'</span>
                AM = (Cfreq + aAM.*cos(2*pi*fAM.*t));
            <span class="keyword">case</span> <span class="string">'sin'</span>
                AM = (Cfreq + aAM.*sin(2*pi*fAM.*t));
            <span class="keyword">case</span> <span class="string">'squ'</span>
                AM = (Cfreq + aAM.*square(2*pi*fAM.*t));
            <span class="keyword">case</span> <span class="string">'saw'</span>
                AM = (Cfreq + aAM.*sawtooth(2*pi*fAM.*t));
            <span class="keyword">otherwise</span>
                AM = 1;
                warning(<span class="string">'Unknown AM modulator type, not modulating'</span>);
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        AM = 1;
    <span class="keyword">end</span>
</pre><h2>Create carrier and apply modulators<a name="8"></a></h2><pre class="codeinput">    xb = zeros(size(t));

    <span class="keyword">switch</span> lower(s.carrier{a,b}(1:3))
        <span class="keyword">case</span> <span class="string">'cos'</span>
            xb = cos(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b)).*AM;
        <span class="keyword">case</span> <span class="string">'sin'</span>
            xb = sin(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b)).*AM;
        <span class="keyword">case</span> <span class="string">'exp'</span>
            xb = exp(1i*(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b))).*AM;
        <span class="keyword">case</span> <span class="string">'saw'</span>
            xb = sawtooth(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b)).*AM;
        <span class="keyword">case</span> <span class="string">'squ'</span>
            xb = square(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b)).*AM;
        <span class="keyword">case</span> <span class="string">'bmp'</span>
            x1 = sqrt(.75)*cos(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b));
            xb = (x1./(1-x1)-1).*AM;
        <span class="keyword">case</span> <span class="string">'noi'</span>
            <span class="keyword">for</span> i = 1:length(t)
                xb(i) = 2*rand-1;
            <span class="keyword">end</span>
            xb = xb.*AM;
        <span class="keyword">case</span> <span class="string">'pls'</span> <span class="comment">%DH added for use with midi</span>
            xb = exp(4*sin(2*pi*fc*t))/exp(4.05);
            s.sc = -1;
        <span class="keyword">otherwise</span>
            error(<span class="string">'Unknown carrier wave type'</span>);
    <span class="keyword">end</span>

    y = ac.*xb;
</pre><h2>Apply delay-and-add circuit<a name="9"></a></h2><pre class="codeinput">    <span class="keyword">if</span> isfield(s, <span class="string">'iter'</span>) &amp;&amp; s.iter(a,b) ~= 0 &amp;&amp; s.Niter(a,b) ~= 0
        iter = floor(s.iter(a,b) * fs);
        Niter = s.Niter(a,b);
        y = stimulusIter(y, iter, Niter);
    <span class="keyword">end</span>
</pre><h2>Add component to signal<a name="10"></a></h2><pre class="codeinput">    x = x + y;
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2012b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% STIMULUSFCN
%  Generates time series for stimulus signal.
%  Called by stimulusMake; not a standalone function.

%%
function x = stimulusFcn(t, s, a)


x = zeros(size(t));               % Initialize signal vector
fs = s.fs;

%% Loop through number of components of signal

for b = 1:length(s.fc(a,:))       % For each component of the section
    
    fc = s.fc{a,b};ac = s.ac{a,b};
    
    if isfield(s, 'FM'), fm = s.fFM{a,b};am = s.aFM{a,b};
    else
        fm = 0;am = 0;
    end
    
    if isfield(s, 'AM'), fAM = s.fAM{a,b};aAM = s.aAM{a,b};
    else
        fAM = 0;aAM = 0;
    end
    
%% Create complete amplitude/frequency vectors if time-varying
    
    temp = {fc fm fAM ac am aAM};
    
    for i = 1:6
        linear = 0;
        if length(temp{i}) > 1
            if length(temp{i}) == 2, linear = 1;end
            temp{i} = interp1(linspace(0,t(end),length(temp{i})),temp{i},t);
            if i < 4
                deriv = diff(temp{i})*fs;
                if linear
                    deriv = -[deriv deriv(end)];
                else
                    deriv = -interp1(linspace(deriv(1),deriv(end),...
                        length(deriv)),deriv,linspace(deriv(1),deriv(end),...
                        length(deriv)+1));
                end
                temp{i} = (temp{i} + t.*deriv/2);
            end
        end
    end
    
    fc = temp{1};fm = temp{2};fAM = temp{3};
    ac = temp{4};am = temp{5};aAM = temp{6};
    
%% Create frequency modulation
    
    if isfield(s, 'FM')
        
        if fm ~= 0
            tflr = floor(t.*fm)./fm;
            trem = rem(t,1./fm);
            q = 2*pi*fm.*t;
            
            switch lower(s.FM{a,b}(1:3))
                case 'cos'
                    mi= ((q-sin(q))/2)/2/pi./fm; % integral of -cos(q)
                case 'saw'
                    mi= tflr/2 + (fm.*trem.^2)/2; % (fm*t.^2)/2 is integral of fm*t
                case 'squ'
                    hlin = zeros(size(trem)); ii = find(trem>1./fm/2); % yuk!!!
                    hlin(ii) = trem(ii)-1./fm/2;
                    mi= (tflr + 2*hlin)/2; % (2*t)/2 is integral of 1
                otherwise
                    am = 0;
                    mi = 0;
                    warning('Unknown FM modulator type, not modulating');
            end
        else
            am = 0;
            mi = 0;
        end
    else
        am = 0;
        mi = 0;
    end
    
%% Create amplitude modulation
    
    if isfield(s, 'AM');
        
        Cfreq = s.CfreqsAM(a,b);
        AM = zeros(size(t));
        
        switch lower(s.AM{a,b})
            case 'cos'
                AM = (Cfreq + aAM.*cos(2*pi*fAM.*t));
            case 'sin'
                AM = (Cfreq + aAM.*sin(2*pi*fAM.*t));
            case 'squ'
                AM = (Cfreq + aAM.*square(2*pi*fAM.*t));
            case 'saw'
                AM = (Cfreq + aAM.*sawtooth(2*pi*fAM.*t));
            otherwise
                AM = 1;
                warning('Unknown AM modulator type, not modulating');
        end
    else
        AM = 1;
    end
    
%% Create carrier and apply modulators
    
    xb = zeros(size(t));
    
    switch lower(s.carrier{a,b}(1:3))
        case 'cos'
            xb = cos(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b)).*AM;
        case 'sin'
            xb = sin(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b)).*AM;
        case 'exp'
            xb = exp(1i*(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b))).*AM;
        case 'saw'
            xb = sawtooth(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b)).*AM;
        case 'squ'
            xb = square(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b)).*AM;
        case 'bmp'
            x1 = sqrt(.75)*cos(2*pi*fc.*t + 2*pi*fc.*am.*mi + s.Th(a,b));
            xb = (x1./(1-x1)-1).*AM;
        case 'noi'
            for i = 1:length(t)
                xb(i) = 2*rand-1;
            end
            xb = xb.*AM;
        case 'pls' %DH added for use with midi
            xb = exp(4*sin(2*pi*fc*t))/exp(4.05);
            s.sc = -1;
        otherwise
            error('Unknown carrier wave type');
    end
    
    y = ac.*xb;
    
%% Apply delay-and-add circuit
    
    if isfield(s, 'iter') && s.iter(a,b) ~= 0 && s.Niter(a,b) ~= 0
        iter = floor(s.iter(a,b) * fs);
        Niter = s.Niter(a,b);
        y = stimulusIter(y, iter, Niter);
    end
    
%% Add component to signal
    
    x = x + y;
    
end

##### SOURCE END #####
--></body></html>